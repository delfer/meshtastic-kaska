# meshtastic-kaska

## Wiring

### Accelerometer

LIS3DH

| Номер пина | Порт | Выбранная функция |
| ---------- | ---- | ----------------- |
| 33         | PA12 | —                 |
| 32         | PA11 | —                 |
| 26         | PB13 | I2C2_SCL          |
| 27         | PB14 | I2C2_SDA          |


### LoRa Sx1276

| **Pin Name** | **Function** | **STM32** |
| ------------ | ------------ | --------- |
| **GND**      | Ground       | GND       |
| **SCK**      | SPI Clock    | 15 PA5    |
| **MISO**     | SPI Data Out | 16 PA6    |
| **MOSI**     | SPI Data In  | 17 PA7    |
| **NSS**      | Chip Select  | 14 PA4    |
| **DIO2**     | Digital I/O  | 18 PB0    |
| **DIO1**     |              | 19 PB1    |
| **DIO0**     |              | 20 PB2    |
| **VCC**      | Power        | 3V3       |
| **NRESET**   | Reset        | 28 PB15   |

### Battery

| Название | Порт | Описание |
| -------- | ---- | -------- |
| V_BATT   | PA3  | Напряжение батареи через мегаомный делитель (1/2) |

## Использование Flash памяти

На основе анализа истории коммитов (`commit-stats.csv`), ниже приведена стоимость различных функций в байтах Flash памяти (STM32L051C8Tx, 64KB Flash):

| Функция / Модуль | Размер (байт) | Коммит | Описание |
| :--- | :--- | :--- | :--- |
| **Базовая прошивка** | ~9 400 | `2ef7de0` | HAL + Blink на PA15/PA9 |
| **Arduino Core & Serial** | +6 192 | `aa476f2` | Инициализация Arduino framework и работа с Serial |
| **I2C Scanner** | +10 444 | `455e9ad` | Добавление `Wire` и логики сканирования (частично оптимизировано позже на -5кб) |
| **Deep Sleep (STM32LowPower)** | +7 224 | `02d7806` | Библиотека энергосбережения и логика сна |
| **Meshtastic + RadioLib** | +25 696 | `5915c6a` | Базовый прием пакетов Meshtastic через RadioLib |
| **Packet Insight (Debug)** | +7 456 | `e66b99a` | Детальный разбор заголовков и вывод в Serial |
| **Decryption (AES-CTR)** | +1 300 | `fb2f622` | Реализация расшифровки пакетов (tiny-aes) |
| **LTO & Оптимизации** | **-8 608** | `84fd8b8` | Включение Link Time Optimization и флагов размера |
| **Battery Monitoring** | +2 180 | `1469d8c` | Чтение ADC и расчет напряжения батареи |
| **Packet Cache** | +592 | `85802b4` | Фильтрация дубликатов и кэширование ID пакетов |

### Ключевые выводы по оптимизации:
- **I2C/Wire:** Занимает довольно много места (~5-10кб), требует аккуратного использования.
- **Floating Point:** Использование `float` в `Serial.print` значительно увеличивает размер. В коммите `7dc1be5` замена на fixed-point позволила сэкономить место при добавлении новых фич.
- **RadioLib:** Модульная структура позволяет отключать неиспользуемые протоколы, что экономит память.
- **LTO:** Самый эффективный способ вернуть ~15% Flash памяти на критических этапах разработки.
