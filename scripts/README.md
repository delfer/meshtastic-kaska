# Скрипт для анализа сборки PlatformIO по истории коммитов

Этот каталог содержит скрипт для автоматической сборки проекта и анализа использования памяти (RAM/Flash) по истории коммитов.

## Скрипт

### `analyze-commits.sh`

Скрипт для анализа использования памяти по истории коммитов. Перебирает указанное количество коммитов, для каждого выполняет сборку (`pio run`) и извлекает статистику RAM/Flash. Результаты сохраняются в CSV файл.

**Особенности:**
- Выполняет `pio clean` до и после каждой сборки (по умолчанию)
- Игнорирует ошибки очистки (не прерывает выполнение)
- Возвращает рабочую директорию в исходное состояние после анализа

**Использование:**
```bash
./scripts/analyze-commits.sh [ПАРАМЕТРЫ]
```

**Параметры:**
- `-n, --count COUNT` – количество анализируемых коммитов (по умолчанию 10, 0 = все коммиты)
- `-b, --branch BRANCH` – ветка для анализа (по умолчанию main)
- `-o, --output FILE` – выходной CSV файл (по умолчанию commit-stats.csv)
- `--skip-built` – пропускать коммиты, уже присутствующие в CSV
- `--no-clean` – не выполнять `pio clean` до и после сборки (ускоряет, но может привести к некорректным результатам)

**Примеры:**
```bash
# Проанализировать последние 5 коммитов
./scripts/analyze-commits.sh -n 5

# Проанализировать все коммиты в ветке develop
./scripts/analyze-commits.sh -b develop -n 0

# Пропустить уже собранные коммиты и не очищать проект
./scripts/analyze-commits.sh --skip-built --no-clean

# Анализ 20 коммитов с сохранением в другой файл
./scripts/analyze-commits.sh --count 20 --output memory-stats.csv
```

**Выходные данные:**
- CSV файл с колонками: date, commit_hash, commit_subject, branch, ram_used, ram_total, ram_percent, flash_used, flash_total, flash_percent, build_status, elapsed_sec
- Статус сборки: success, build_failed, missing_platformio, no_stats

## Требования

- Bash
- Git
- PlatformIO (установленный локально, путь по умолчанию `~/.platformio/penv/bin/pio`)
- Проект PlatformIO с файлом `platformio.ini`

## Установка

1. Убедитесь, что скрипт исполняемый:
   ```bash
   chmod +x scripts/analyze-commits.sh
   ```

2. При необходимости измените путь к PlatformIO в скрипте или задайте переменную окружения `PIO_BIN`.

## Использование в git hooks

Скрипт `analyze-commits.sh` предназначен для анализа истории коммитов, а не для автоматического запуска после каждого коммита. Если вам нужно собирать статистику после каждого коммита, вы можете создать простой hook, который запускает сборку для текущего коммита (например, используя `pio run` и извлекая статистику). Пример такого hook можно создать на основе логики `analyze-commits.sh`.

## Примечания

- Сборка каждого коммита может занимать время (десятки секунд). Для больших историй используйте ограничение по количеству коммитов.
- При переключении коммитов скрипт возвращает рабочую директорию в исходное состояние.
- Если в старых коммитах отсутствует `platformio.ini`, сборка пропускается.
- По умолчанию скрипт выполняет `pio clean` до и после каждой сборки. Ошибки очистки игнорируются (выводится предупреждение), что не влияет на процесс анализа.
- Используйте параметр `--no-clean` для отключения очистки, что ускорит выполнение, но может привести к некорректным результатам из-за кэшированных файлов.